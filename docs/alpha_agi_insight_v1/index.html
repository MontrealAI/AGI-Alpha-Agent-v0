<!DOCTYPE html>
<html lang="en" data-theme="light">
  <head>
    <meta charset="utf-8" />
    <meta
      http-equiv="Content-Security-Policy"
      content="default-src 'self'; connect-src 'self' https://api.openai.com; script-src 'self' 'wasm-unsafe-eval' 'sha384-177zXf5eB3dnF9pKwGvc3ITN0EN04yL+Lju+41FYl59Rk/ooEBgXYv3+I8s/0zR0' 'sha384-79nEfECpiwNfTKeXO3LCt0sLutpd3k4stwrBgGfcJBKvwd9SsNd9wIP34JDO4M50' 'sha384-8HQw6fPoy8+LmIQ4EBvud4Xv3wVIwuWPb28UlhFF/NbRlaIaUcC0UERfAoJQC8dw' 'sha384-eR8sYzoSk2xJcnjk7RVrsGWKil+DbPgMionlm2xuFpCTJRuyTQ/l6jHF2OY7ZnIL'; style-src 'self' 'unsafe-inline'"
    />
    <title>α-AGI Insight</title>
    <meta name="viewport" content="width=device-width, initial-scale=1" />

    <link href="assets/daisyui.min.css" rel="stylesheet" type="text/css" />
    <script type="importmap">
      {
        "imports": {
          "d3": "./d3.exports.js"
        }
      }
    </script>

    <script>
      // Provide a resilient toast implementation before deferred modules load.
      // The Playwright offline checks rely on these calls not throwing.
      if (typeof window.toast !== "function") {
        window.toast = (msg) => {
          const t = document.getElementById("toast");
          if (t) {
            t.textContent = msg;
            t.classList.add("show");
            clearTimeout(window.toast.id);
            window.toast.id = window.setTimeout(() => t.classList.remove("show"), 2000);
            return;
          }
          console.warn(msg);
        };
      }
    </script>

    <script>
      const SW_URL = "service-worker.js";
      const SW_HASH = "sha384-jNrRb0RaME0Q+lz0/ITUhfnQBDj97uJPtmPXPc9rSfGvo79YnRebfKvL0rUyytDQ";
      const SKIP_SW =
        window.__INSIGHT_SKIP_SW__ ||
        window.location.hostname === "127.0.0.1" ||
        window.location.hostname === "localhost";

      if (!SKIP_SW && "serviceWorker" in navigator) {
        window.addEventListener("load", async () => {
          try {
            const res = await fetch(SW_URL);
            const buf = await res.arrayBuffer();
            const digest = await crypto.subtle.digest("SHA-384", buf);
            const b64 = btoa(String.fromCharCode(...new Uint8Array(digest)));
            if (`sha384-${b64}` !== SW_HASH) {
              throw new Error("Service worker hash mismatch");
            }

            navigator.serviceWorker.register(SW_URL).then((registration) => {
              navigator.serviceWorker.ready.then(() => {
                registration.addEventListener("updatefound", () => {
                  const newWorker = registration.installing;
                  if (!newWorker) return;

                  newWorker.addEventListener("statechange", () => {
                    if (newWorker.state === "installed") {
                      window.toast("Update available — reload to use the latest version.");
                    }
                  });
                });
              });
            });
          } catch (err) {
            console.error(err);
            window.toast(`Service worker failed: ${err.message}`);
          }
        });
      }
    </script>
  </head>
  <body>
    <main>
      <h1>α-AGI Insight</h1>
      <div id="root" data-testid="app"></div>
    </main>
    <div id="toast" role="status" aria-live="polite"></div>

    <script>
      document.addEventListener("DOMContentLoaded", () => {
        document.documentElement.dataset.insightReady = "1";
      });
    </script>

    <script
      type="module"
      src="insight.bundle.js"
      integrity="sha384-qqzAGf6VRJL+I4Dck8OU9CVoUwcYpwsVQLazxhFbOW+7fcqY/yHDRVcblo9xWnYz"
      crossorigin="anonymous"
    ></script>
    <script>
      window.PINNER_TOKEN = atob("");
      window.OTEL_ENDPOINT = atob("");
      window.IPFS_GATEWAY = atob("");
    </script>
  </body>
</html>
