<!DOCTYPE html>
<!-- [See docs/DISCLAIMER_SNIPPET.md](docs/DISCLAIMER_SNIPPET.md) -->
<html lang="en" data-theme="light">
  <head>
    <meta charset="utf-8" />
    <meta http-equiv="Content-Security-Policy" content="default-src 'self'; connect-src 'self' https://api.openai.com; script-src 'self' 'wasm-unsafe-eval' 'sha384-J1kfFaEtujKM8se2onx8/tKv/t+AcMkKMUSD751Op4IiE2IiCdlpHaiBB/UlIIgd' 'sha384-wmBbMOjwxvJ39aarpffMTUEI3kl5FrgDlzNQUmksWmpx939OHQPRuMBvHNQp/teR' 'sha384-/Nk3BsDXRZ9RoSihEbzD13y2pDelDAgbl26jWSDX5Ks9+h6NL60Y3Fs7Z4JdWZbn' 'sha384-c/zH/BUAqxtBZKIM/eb5rz+z6KrUTGTYsDxNZ7kbhs6EXsCllwcB+Erbpnx6lkf7' 'sha384-eR8sYzoSk2xJcnjk7RVrsGWKil+DbPgMionlm2xuFpCTJRuyTQ/l6jHF2OY7ZnIL'; style-src 'self' 'unsafe-inline'" />
    <title>α-AGI Insight</title>
    <meta name="viewport" content="width=device-width, initial-scale=1" />

    <link rel="stylesheet" href="style.css" />
    <style>
      .sr-only {
        position: absolute;
        width: 1px;
        height: 1px;
        padding: 0;
        margin: -1px;
        overflow: hidden;
        clip: rect(0, 0, 0, 0);
        border: 0;
      }
    </style>

    <script src="assets/d3.v7.min.js" crossorigin="anonymous"></script>
    <script src="assets/lib/bundle.esm.min.js" crossorigin="anonymous"></script>
    <script src="assets/wasm/pyodide.js" crossorigin="anonymous"></script>

    <script type="importmap">
      {
        "imports": {
          "d3": "./assets/d3.exports.js"
        }
      }
    </script>

    <script>
      // Provide a resilient toast implementation before deferred modules load.
      // The Playwright offline checks rely on these calls not throwing.
      if (typeof window.toast !== 'function') {
        window.toast = (msg) => {
          const t = document.getElementById('toast');
          if (t) {
            t.textContent = msg;
            t.classList.add('show');
            clearTimeout(window.toast.id);
            window.toast.id = window.setTimeout(() => t.classList.remove('show'), 2000);
            return;
          }
          console.warn(msg);
        };
      }
    </script>

    <script>
      const SW_URL = 'service-worker.js';
      const SW_HASH = 'sha384-kQo+PZJcRiSq81DoHg7dyh+D8v/XRPNke0/dvpo2pT968hYeKRy2hfcZk4KYSIh5';

      if ('serviceWorker' in navigator) {
        window.addEventListener('load', async () => {
          try {
            const res = await fetch(SW_URL);
            const buf = await res.arrayBuffer();
            const digest = await crypto.subtle.digest('SHA-384', buf);
            const b64 = btoa(String.fromCharCode(...new Uint8Array(digest)));
            if (`sha384-${b64}` !== SW_HASH) {
              throw new Error('Service worker hash mismatch');
            }

            navigator.serviceWorker.register(SW_URL).then((registration) => {
              navigator.serviceWorker.ready.then(() => {
                registration.addEventListener('updatefound', () => {
                  const newWorker = registration.installing;
                  if (!newWorker) return;

                  newWorker.addEventListener('statechange', () => {
                    if (newWorker.state === 'installed') {
                      window.toast('Update available — reload to use the latest version.');
                    }
                  });
                });
              });
            });
          } catch (err) {
            console.error(err);
            window.toast('Service worker failed: ' + err.message);
          }
        });
      }
    </script>
  </head>
  <body>
    <main id="app">
      <h1 class="sr-only">α-AGI Insight</h1>
      <div id="root" data-testid="app"></div>
    </main>
    <div id="toast" class="toast toast-bottom toast-end" role="status" aria-live="polite"></div>

    <script type="module" src="insight.bundle.js" integrity="sha384-4YDjizau6PeT3xXybq5XBDOYDhqLQaxggECxdXbqykx936VD3N84zTElKogFECMw" crossorigin="anonymous"></script>
    <script>
      (() => {
        const root = document.getElementById('root');
        if (!root) return;
        const markReady = () => {
          if (root.childElementCount > 0 || document.querySelector('svg, canvas')) {
            document.documentElement.dataset.insightReady = '1';
            return true;
          }
          return false;
        };
        if (markReady()) return;
        let attempts = 0;
        const tick = () => {
          attempts += 1;
          if (markReady() || attempts > 240) return;
          requestAnimationFrame(tick);
        };
        requestAnimationFrame(tick);
      })();
    </script>
    <script>window.PINNER_TOKEN=atob('');window.OTEL_ENDPOINT=atob('');window.IPFS_GATEWAY=atob('');</script>
  </body>
</html>
