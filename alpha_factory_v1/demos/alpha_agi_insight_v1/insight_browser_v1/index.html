<!DOCTYPE html>
<meta charset="utf-8" />
<title>α-AGI Insight – in-browser Pareto explorer</title>
<link rel="stylesheet" href="style.css" />
<link rel="stylesheet" href="src/ui/controls.css" />

<div id="controls"></div>
<div id="toast"></div>
<script src="d3.v7.min.js"></script>
<script type="module">
import {parseHash,toHash} from './src/config/params.js';
import {initControls} from './src/ui/ControlsPanel.js';

function lcg(seed){return()=>((seed=Math.imul(1664525,seed)+1013904223)>>>0)/2**32}
function nonDominated(pop){return pop.filter(a=>!pop.some(b=>
 (b.logic>=a.logic && b.feasible>=a.feasible) && (b.logic>a.logic||b.feasible>a.feasible)))}

let panel
function toast(msg){const t=document.getElementById('toast');t.textContent=msg;t.classList.add('show');clearTimeout(toast.id);toast.id=setTimeout(()=>t.classList.remove('show'),2e3)}

function start(p){
  const rand=lcg(p.seed)
  let pop=Array.from({length:p.pop},()=>({logic:rand(),feasible:rand()}))
  const svg=d3.select('body').append('svg').attr('viewBox','0 0 500 500')
  const x=d3.scaleLinear().domain([0,1]).range([40,460]),
        y=d3.scaleLinear().domain([0,1]).range([460,40])
  const dot=svg.append('g')
  const info=svg.append('text').attr('x',20).attr('y',30).attr('fill','#fff')
  let gen=0
  const step=()=>{
    info.text(`gen ${gen}`)
    dot.selectAll('circle').data(pop)
       .join('circle')
       .attr('cx',d=>x(d.logic)).attr('cy',d=>y(d.feasible))
       .attr('r',3).attr('fill',d=>d.front?'#00afff':'#666')
    if(gen++>=p.gen)return
    pop=pop.concat(pop.map(d=>({
      logic:Math.min(1,Math.max(0,d.logic+(rand()-.5)*.12)),
      feasible:Math.min(1,Math.max(0,d.feasible+(rand()-.5)*.12))
    })))
    pop.forEach(d=>d.front=false)
    nonDominated(pop).forEach(d=>d.front=true)
    pop=nonDominated(pop).concat(d3.shuffle(pop).slice(0,p.pop-10))
    requestAnimationFrame(step)
  }
  step()
}

function apply(p){location.hash=toHash(p)}

window.addEventListener('DOMContentLoaded',()=>{panel=initControls(parseHash(),apply);window.dispatchEvent(new HashChangeEvent('hashchange'))})
window.addEventListener('hashchange',()=>{const p=parseHash();panel.setValues(p);d3.select('svg').remove();start(p);toast('simulation restarted')})
</script>
