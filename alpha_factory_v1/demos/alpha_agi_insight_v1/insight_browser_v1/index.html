<!DOCTYPE html>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>α-AGI Insight – in-browser Pareto explorer</title>
<link rel="stylesheet" href="src/style/theme.css" />
<link rel="stylesheet" href="style.css" />
<link rel="stylesheet" href="src/ui/controls.css" />

<div id="controls"></div>
<div id="toast"></div>
<div id="toolbar"></div>
<div id="legend"></div>
<script src="d3.v7.min.js"></script>
<script type="module">
import {parseHash,toHash} from './src/config/params.js';
import {initControls} from './src/ui/ControlsPanel.js';
import {renderFrontier,addGlow} from './src/render/frontier.js';
import {save,load} from './src/state/serializer.js';
import {initDragDrop} from './src/ui/dragdrop.js';
import {toCSV} from './src/utils/csv.js';
import {svg2png} from './src/render/svg2png.js';
import {strategyColors} from './src/render/colors.js';
import {pinFiles} from './src/ipfs/pinner.js';
import {initGestures} from './src/ui/gestures.js';

function lcg(seed){
  function rand(){
    seed=Math.imul(1664525,seed)+1013904223>>>0;
    return seed/2**32;
  }
  rand.state=()=>seed;
  rand.set=s=>{seed=s>>>0;};
  return rand;
}

let panel,pauseBtn,exportBtn,dropZone
let current,rand,pop,gen,svg,view,x,y,info,running=true
let worker
function toast(msg){const t=document.getElementById('toast');t.textContent=msg;t.classList.add('show');clearTimeout(toast.id);toast.id=setTimeout(()=>t.classList.remove('show'),2e3)}
window.toast=toast;

function applyTheme(t){
  document.documentElement.dataset.theme=t;
}
function loadTheme(){
  const saved=localStorage.getItem('theme');
  if(saved) applyTheme(saved);
  else if(window.matchMedia('(prefers-color-scheme:light)').matches) applyTheme('light');
}
function toggleTheme(){
  const cur=document.documentElement.dataset.theme==='light'?'light':'dark';
  const next=cur==='light'?'dark':'light';
  applyTheme(next);
  localStorage.setItem('theme',next);
}

function setupView(){
  d3.select('svg').remove();
  svg=d3.select('body').append('svg')
        .attr('viewBox','0 0 500 500')
        .style('touch-action','none');
  view=svg.append('g');
  x=d3.scaleLinear().domain([0,1]).range([40,460])
  y=d3.scaleLinear().domain([0,1]).range([460,40])
  addGlow(svg)
  info=svg.append('text').attr('x',20).attr('y',30).attr('fill','#fff')
  initGestures(svg.node(), view.node ? view.node() : view)
}

function updateLegend(strats){
  const legend=document.getElementById('legend');
  legend.innerHTML='';
  for(const s of strats){
    const span=document.createElement('span');
    const sw=document.createElement('i');
    sw.style.background=strategyColors[s];
    sw.style.display='inline-block';
    sw.style.width='10px';
    sw.style.height='10px';
    sw.style.marginRight='4px';
    span.appendChild(sw);
    span.append(s);
    legend.appendChild(span);
  }
}

function start(p){
  current=p
  rand=lcg(p.seed)
  pop=Array.from({length:p.pop},()=>({logic:rand(),feasible:rand(),strategy:'base'}))
  gen=0
  running=true
  setupView()
  updateLegend(p.mutations)
  if(worker) worker.terminate()
  worker=new Worker('./worker/evolver.js',{type:'module'})
  worker.onmessage=ev=>{pop=ev.data.pop;rand.set(ev.data.rngState);requestAnimationFrame(step)}
  step()
}

function step(){
  info.text(`gen ${gen}`)
  renderFrontier(view,pop,x,y)
  if(!running)return
  if(gen++>=current.gen){worker.terminate();return}
  worker.postMessage({pop,rngState:rand.state(),mutations:current.mutations,popSize:current.pop})
}

function togglePause(){
  running=!running
  pauseBtn.textContent=running?'Pause':'Resume'
  if(running)requestAnimationFrame(step)
}

function exportState(){
  pop.gen=gen
  const json=save(pop,rand.state())
  const a=document.createElement('a')
  a.href=URL.createObjectURL(new Blob([json],{type:'application/json'}))
  a.download='state.json'
  a.click()
  URL.revokeObjectURL(a.href)
}

function exportCSV(data){
  const csv = toCSV(data);
  const a = document.createElement("a");
  a.href = URL.createObjectURL(new Blob([csv], {type: "text/csv"}));
  a.download = "population.csv";
  a.click();
  URL.revokeObjectURL(a.href);
}

async function exportPNG(){
  if(!svg) return;
  const blob = await svg2png(svg.node ? svg.node() : svg.node());
  const a = document.createElement("a");
  a.href = URL.createObjectURL(blob);
  a.download = "frontier.png";
  a.click();
  URL.revokeObjectURL(a.href);
}

function loadState(text){
  try{
    const s=load(text)
    pop=s.pop
    gen=s.gen
    rand=lcg(0);rand.set(s.rngState)
    running=true
    pauseBtn.textContent='Pause'
    setupView()
    updateLegend(current.mutations)
    if(worker) worker.terminate()
    worker=new Worker('./worker/evolver.js',{type:'module'})
    worker.onmessage=ev=>{pop=ev.data.pop;rand.set(ev.data.rngState);requestAnimationFrame(step)}
    step()
    toast('state loaded')
  }catch{toast('invalid file')}
}

function apply(p){location.hash=toHash(p)}

window.addEventListener('DOMContentLoaded',()=>{
  loadTheme()
  panel=initControls(parseHash(),apply)
  pauseBtn=panel.pauseBtn
  exportBtn=panel.exportBtn
  dropZone=panel.dropZone
  const tb=document.getElementById("toolbar");
  const csvBtn=document.createElement("button");
  csvBtn.textContent="CSV";
  const pngBtn=document.createElement("button");
  pngBtn.textContent="PNG";
  const shareBtn=document.createElement("button");
  shareBtn.textContent="Share";
  const themeBtn=document.createElement("button");
  themeBtn.textContent="Theme";
  tb.appendChild(csvBtn);
  tb.appendChild(pngBtn);
  tb.appendChild(shareBtn);
  tb.appendChild(themeBtn);
  csvBtn.addEventListener("click",()=>exportCSV(pop));
  pngBtn.addEventListener("click",exportPNG);
  shareBtn.addEventListener("click",async()=>{
    const snippet=`<iframe src="${location.origin+location.pathname+location.hash}"></iframe>`;
    if(navigator.clipboard){
      try{await navigator.clipboard.writeText(snippet);}catch{}}
    toast('iframe snippet copied');
    if(window.PINNER_TOKEN){
      const file=new File([snippet],"snippet.html",{type:"text/html"});
      await pinFiles([file]);
    }
  });
  themeBtn.addEventListener("click",toggleTheme);
  pauseBtn.addEventListener('click',togglePause)
  exportBtn.addEventListener('click',exportState)
  initDragDrop(dropZone,loadState)
  window.dispatchEvent(new HashChangeEvent('hashchange'))
})
window.addEventListener('hashchange',()=>{const p=parseHash();panel.setValues(p);start(p);toast('simulation restarted')})
</script>
