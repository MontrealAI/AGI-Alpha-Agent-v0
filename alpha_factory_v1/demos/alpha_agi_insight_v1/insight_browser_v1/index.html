<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <meta name="theme-color" content="#0d0e2e" />
    <meta
      http-equiv="Content-Security-Policy"
      content="default-src 'self'; connect-src 'self'; script-src 'self' 'wasm-unsafe-eval'"
    />
    <title>α-AGI Insight – in-browser Pareto explorer</title>
    <link rel="icon" href="favicon.svg" type="image/svg+xml" />
    <link rel="manifest" href="manifest.json" />
    <link rel="stylesheet" href="src/style/theme.css" />
    <link rel="stylesheet" href="style.css" />
    <link rel="stylesheet" href="src/ui/controls.css" />
  </head>
  <body class="min-h-screen flex flex-col">
    <header class="hero relative py-16">
      <div class="parallax absolute inset-0 -z-10">
        <div class="stars"></div>
        <div class="stars2"></div>
      </div>
      <div class="hero-content text-center">
        <h1
          class="text-5xl font-bold bg-gradient-to-r from-purple-400 via-pink-500 to-red-500 \
          bg-clip-text text-transparent animate-gradient"
        >
          α‑AGI Insight
        </h1>
      </div>
    </header>
    <div class="flex flex-1 overflow-hidden">
      <aside id="controls" class="w-64 bg-base-100/70 backdrop-blur-md p-4 overflow-y-auto"></aside>
      <main id="canvas" class="flex-1 relative overflow-hidden"></main>
      <aside id="log" class="w-80 bg-base-100/70 backdrop-blur-md p-4 overflow-y-auto" aria-label="Log"></aside>
    </div>
    <div id="toast"></div>
    <div id="toolbar"></div>
    <div id="legend"></div>
    <script
      src="d3.v7.min.js"
      integrity="sha384-QqrLqBpBJfpJ/24ZmCV87BPpk+Sj9GkH5DzKZdwS4d47ZojhpdfvBiF+BgWe8zX8"
      crossorigin="anonymous"
    ></script>
    <script src="bundle.esm.min.js" integrity="sha384-HCq3AUAghBODOAg7+u+o8u2pKjENSb3YGAjRfL6TZgAY49LXzq1SaOwNtQmWsIax" crossorigin="anonymous"></script>
    <script src="pyodide.js" integrity="sha384-4lQJt6JNK5sYso6mEO1s2l1EnmbkIm958N+CAuWcYFBPuizBJ5nENroO7dtV8upW" crossorigin="anonymous"></script>
    <script>
      if ('serviceWorker' in navigator) {
        window.addEventListener('load', () => {
          navigator.serviceWorker.register('sw.js');
        });
      }
    </script>
<script type="module">
import {parseHash,toHash} from './src/config/params.js';
import {initControls} from './src/ui/ControlsPanel.js';
import {renderFrontier} from './src/render/frontier.js';
import {save,load} from './src/state/serializer.js';
import {initDragDrop} from './src/ui/dragdrop.js';
import {toCSV} from './src/utils/csv.js';
import {svg2png} from './src/render/svg2png.js';
import {strategyColors} from './src/render/colors.js';
import {pinFiles} from './src/ipfs/pinner.js';
import {initGestures} from './src/ui/gestures.js';
import {initFpsMeter} from './src/ui/fpsMeter.js';
import {initI18n,t} from './src/ui/i18n.js';
import {chat as llmChat} from './src/utils/llm.js';

function lcg(seed){
  function rand(){
    seed=Math.imul(1664525,seed)+1013904223>>>0;
    return seed/2**32;
  }
  rand.state=()=>seed;
  rand.set=s=>{seed=s>>>0;};
  return rand;
}

let panel,pauseBtn,exportBtn,dropZone
let current,rand,pop,gen,svg,view,info,running=true
let worker
let fpsStarted=false;
function toast(msg) {
  const t = document.getElementById('toast');
  t.textContent = msg;
  t.classList.add('show');
  clearTimeout(toast.id);
  toast.id = setTimeout(() => t.classList.remove('show'), 2000);
}
window.toast = toast;
window.llmChat=llmChat;

function applyTheme(t){
  document.documentElement.dataset.theme=t;
}
function loadTheme(){
  const saved=localStorage.getItem('theme');
  if(saved) applyTheme(saved);
  else if(window.matchMedia('(prefers-color-scheme:light)').matches) applyTheme('light');
}
function toggleTheme(){
  const cur=document.documentElement.dataset.theme==='light'?'light':'dark';
  const next=cur==='light'?'dark':'light';
  applyTheme(next);
  localStorage.setItem('theme',next);
}

function setupView(){
  d3.select('#canvas').select('svg').remove();
  svg=d3.select('#canvas').append('svg')
        .attr('viewBox','0 0 500 500')
        .style('touch-action','none');
  view=svg.append('g');
  info=svg.append('text').attr('x',20).attr('y',30).attr('fill','#fff')
  initGestures(svg.node(), view.node ? view.node() : view)
}

function updateLegend(strats){
  const legend=document.getElementById('legend');
  legend.innerHTML='';
  for(const s of strats){
    const span=document.createElement('span');
    const sw=document.createElement('i');
    sw.style.background=strategyColors[s];
    sw.style.display='inline-block';
    sw.style.width='10px';
    sw.style.height='10px';
    sw.style.marginRight='4px';
    span.appendChild(sw);
    span.append(s);
    legend.appendChild(span);
  }
}

function start(p){
  current=p
  rand=lcg(p.seed)
  pop=Array.from({length:p.pop},()=>({logic:rand(),feasible:rand(),strategy:'base'}))
  gen=0
  running=true
  setupView()
  if(!fpsStarted){initFpsMeter(() => running);fpsStarted=true;}
  updateLegend(p.mutations)
  if(worker) worker.terminate()
  worker=new Worker('./worker/evolver.js',{type:'module'})
  worker.onmessage=ev=>{pop=ev.data.pop;rand.set(ev.data.rngState);requestAnimationFrame(step)}
  step()
}

function step(){
  info.text(`gen ${gen}`)
  renderFrontier(view.node ? view.node() : view,pop)
  if(!running)return
  if(gen++>=current.gen){worker.terminate();return}
  worker.postMessage({pop,rngState:rand.state(),mutations:current.mutations,popSize:current.pop})
}

function togglePause(){
  running=!running
  pauseBtn.textContent=running?t('pause'):t('resume')
  if(running)requestAnimationFrame(step)
}

async function exportState(){
  pop.gen=gen
  const json=save(pop,rand.state())
  const blob=new Blob([json],{type:'application/json'})
  const a=document.createElement('a')
  a.href=URL.createObjectURL(blob)
  a.download='state.json'
  a.click()
  URL.revokeObjectURL(a.href)
  if(window.PINNER_TOKEN){
    const file=new File([json],'state.json',{type:'application/json'})
    await pinFiles([file])
  }
}

function exportCSV(data){
  const csv = toCSV(data);
  const a = document.createElement("a");
  a.href = URL.createObjectURL(new Blob([csv], {type: "text/csv"}));
  a.download = "population.csv";
  a.click();
  URL.revokeObjectURL(a.href);
}

async function exportPNG(){
  if(!svg) return;
  const blob = await svg2png(svg.node ? svg.node() : svg.node());
  const a = document.createElement("a");
  a.href = URL.createObjectURL(blob);
  a.download = "frontier.png";
  a.click();
  URL.revokeObjectURL(a.href);
}

function loadState(text){
  try{
    const s=load(text)
    pop=s.pop
    gen=s.gen
    rand=lcg(0);rand.set(s.rngState)
    running=true
    pauseBtn.textContent=t('pause')
    setupView()
    updateLegend(current.mutations)
    if(worker) worker.terminate()
    worker=new Worker('./worker/evolver.js',{type:'module'})
    worker.onmessage=ev=>{pop=ev.data.pop;rand.set(ev.data.rngState);requestAnimationFrame(step)}
    step()
    toast(t('state_loaded'))
  }catch{toast(t('invalid_file'))}
}

function apply(p){location.hash=toHash(p)}

window.addEventListener('DOMContentLoaded',async()=>{
  await initI18n()
  loadTheme()
  panel=initControls(parseHash(),apply)
  pauseBtn=panel.pauseBtn
  exportBtn=panel.exportBtn
  dropZone=panel.dropZone
  const tb=document.getElementById("toolbar");
  const csvBtn=document.createElement("button");
  csvBtn.textContent=t('csv');
  const pngBtn=document.createElement("button");
  pngBtn.textContent=t('png');
  const shareBtn=document.createElement("button");
  shareBtn.textContent=t('share');
  const themeBtn=document.createElement("button");
  themeBtn.textContent=t('theme');
  tb.appendChild(csvBtn);
  tb.appendChild(pngBtn);
  tb.appendChild(shareBtn);
  tb.appendChild(themeBtn);
  csvBtn.addEventListener("click",()=>exportCSV(pop));
  pngBtn.addEventListener("click",exportPNG);
  shareBtn.addEventListener("click", async () => {
    const url = location.origin + location.pathname + location.hash;
    let pinned = null;
    if (window.PINNER_TOKEN) {
      const json = save(pop, rand.state());
      const file = new File([json], "state.json", { type: "application/json" });
      pinned = await pinFiles([file]);
    }
    if (pinned && pinned.url) {
      if (navigator.clipboard) {
        try { await navigator.clipboard.writeText(pinned.url); } catch {}
      }
      toast(`pinned ${pinned.cid}`);
    } else {
      if (navigator.clipboard) {
        try { await navigator.clipboard.writeText(url); } catch {}
      }
      toast(t('link_copied'));
    }
  });
  themeBtn.addEventListener("click",toggleTheme);
  pauseBtn.addEventListener('click',togglePause)
  exportBtn.addEventListener('click',exportState)
  initDragDrop(dropZone,loadState)
  window.dispatchEvent(new HashChangeEvent('hashchange'))
})
window.addEventListener('hashchange', () => {
  const p = parseHash();
  panel.setValues(p);
  start(p);
  toast(t('simulation_restarted'));
});
</script>
  </body>
</html>
