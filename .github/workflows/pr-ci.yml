name: "âœ… PR CI"

on:
  pull_request:
    branches: ["main"]
  push:
    branches: ["main"]
  merge_group:
  workflow_dispatch:

permissions:
  contents: read

concurrency:
  group: ${{ github.workflow }}-${{ github.ref }}
  cancel-in-progress: true

defaults:
  run:
    shell: bash

env:
  PYTHON_VERSION: "3.12"
  PIP_DISABLE_PIP_VERSION_CHECK: "1"
  AGIALPHA_ADDRESS: "0xa61a3b3a130a9c20768eebf97e21515a6046a1fa"
  AGIALPHA_DECIMALS: 18

jobs:
  lint:
    name: "Lint (ruff)"
    runs-on: ubuntu-latest
    timeout-minutes: 20
    steps:
      - uses: actions/checkout@v4.2.2 # 11bd71901bbe5b1630ceea73d27597364c9af683
      - name: Check binary diff (early)
        run: scripts/check_no_binary_diff.sh
      - uses: actions/setup-python@v5.6.0 # a26af69be951a213d495a4c3e4e4022e16d87065
        with:
          python-version: ${{ env.PYTHON_VERSION }}
          cache: pip
          cache-dependency-path: |
            requirements.lock
            requirements-dev.lock
      - name: Verify $AGIALPHA configuration
        run: python scripts/check_agialpha_config.py
      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install -r requirements.lock
          pip install -r requirements-dev.lock
      - name: Ruff check
        run: ruff check .

  smoke:
    name: "Smoke tests"
    if: ${{ always() }}
    needs: lint
    runs-on: ubuntu-latest
    timeout-minutes: 20
    steps:
      - uses: actions/checkout@v4.2.2 # 11bd71901bbe5b1630ceea73d27597364c9af683
      - name: Check binary diff (early)
        run: scripts/check_no_binary_diff.sh
      - uses: actions/setup-python@v5.6.0 # a26af69be951a213d495a4c3e4e4022e16d87065
        with:
          python-version: ${{ env.PYTHON_VERSION }}
          cache: pip
          cache-dependency-path: |
            requirements.lock
            requirements-dev.lock
      - name: Verify $AGIALPHA configuration
        run: python scripts/check_agialpha_config.py
      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install -r requirements.lock
          pip install -r requirements-dev.lock
      - name: Run smoke tests
        run: |
          pytest -m smoke \
            tests/test_af_requests.py \
            tests/test_cache_version.py \
            tests/test_check_env_core.py \
            tests/test_check_env_network.py \
            tests/test_config_settings.py \
            tests/test_config_utils.py \
            tests/test_ping_agent.py -q
