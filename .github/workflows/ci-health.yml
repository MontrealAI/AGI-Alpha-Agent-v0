name: "ðŸ©º CI Health"

on:
  workflow_dispatch:
  schedule:
    - cron: "0 * * * *"
  workflow_run:
    workflows:
      - "ðŸš€ CI â€” Insight Demo"
      - "âœ… PR CI"
      - "ðŸ”¥ Smoke Test"
    types:
      - completed

permissions:
  contents: read
  actions: write
  checks: read
  statuses: read
  pull-requests: read
  # Keep permissions limited to supported keys recognized by GitHub Actions.
  # Allowed keys: actions, checks, contents, deployments, id-token,
  # issues, discussions, packages, pages, pull-requests, repository-projects,
  # security-events, statuses.

concurrency:
  group: ${{ github.workflow }}-${{ github.ref }}
  cancel-in-progress: true

jobs:
  ci-health:
    name: "CI watchdog"
    runs-on: ubuntu-latest
    timeout-minutes: 30
    env:
      ADMIN_GITHUB_TOKEN: ${{ secrets.ADMIN_GITHUB_TOKEN }}
      AGIALPHA_ADDRESS: "0xa61a3b3a130a9c20768eebf97e21515a6046a1fa"
      AGIALPHA_DECIMALS: 18
    steps:
      - uses: actions/checkout@v4.2.2 # 11bd71901bbe5b1630ceea73d27597364c9af683
      - name: Resolve CI target branch
        run: |
          default_branch=${{ github.event.repository.default_branch || 'main' }}
          target_branch="$default_branch"

          if [[ "${{ github.event_name }}" == "workflow_run" ]]; then
            pr_base=$(jq -r '.workflow_run.pull_requests[0].base.ref // empty' "$GITHUB_EVENT_PATH")
            event_type=$(jq -r '.workflow_run.event // empty' "$GITHUB_EVENT_PATH")

            if [[ "$event_type" == "pull_request" && -n "$pr_base" ]]; then
              target_branch="$pr_base"
            fi
          fi

          echo "CI_TARGET_BRANCH=$target_branch" >> "$GITHUB_ENV"
      - name: Verify $AGIALPHA configuration
        run: python scripts/check_agialpha_config.py
      - uses: actions/setup-python@v5.6.0 # a26af69be951a213d495a4c3e4e4022e16d87065
        with:
          python-version: "3.12"
      - name: Install watchdog dependencies
        run: |
          python -m pip install --upgrade pip
          # keep runtime lean by installing only the libraries required by the
          # watchdog scripts.
          python -m pip install \
            pyyaml \
            "requests>=2.32,<3"
      - name: Check CI health and remediate
        env:
          GITHUB_TOKEN: ${{ secrets.ADMIN_GITHUB_TOKEN || github.token }}
          GH_TOKEN: ${{ secrets.ADMIN_GITHUB_TOKEN || github.token }}
        run: |
          python scripts/check_ci_status.py \
            --wait-minutes 5 \
            --pending-grace-minutes 45 \
            --stale-minutes 90 \
            --cancel-stale \
            --dispatch-missing \
            --rerun-failed \
            --poll-seconds 30 \
            --branch "${CI_TARGET_BRANCH}" \
            --ref "${CI_TARGET_BRANCH}"
      - name: Warn when admin token is unavailable
        if: ${{ env.ADMIN_GITHUB_TOKEN == '' }}
        run: echo "::warning::ADMIN_GITHUB_TOKEN not configured; branch protection verification skipped."

      - name: Verify branch protection on main
        if: ${{ env.ADMIN_GITHUB_TOKEN != '' }}
        env:
          # Requires a fine-grained or classic PAT with administration access
          # to branch protection settings. The default GITHUB_TOKEN lacks this
          # scope and will return 403s when querying protection rules.
          GITHUB_TOKEN: ${{ env.ADMIN_GITHUB_TOKEN }}
        run: |
          python scripts/verify_branch_protection.py \
            --branch "${CI_TARGET_BRANCH}" \
            --apply \
            --required-checks-file scripts/required_checks.json
