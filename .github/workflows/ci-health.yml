name: "ğŸ©º CI Health"

on:
  workflow_dispatch:
  schedule:
    - cron: "0 * * * *"
  workflow_run:
    workflows:
      - "ğŸš€ CI â€” Insight Demo"
      - "âœ… PR CI"
      - "ğŸ”¥ Smoke Test"
    types:
      - completed

permissions:
  contents: read
  actions: write
  administration: read  # Required to read branch protection for enforcement checks

concurrency:
  group: ${{ github.workflow }}-${{ github.ref }}
  cancel-in-progress: true

jobs:
  ci-health:
    name: "CI watchdog"
    runs-on: ubuntu-latest
    timeout-minutes: 20
    steps:
      - uses: actions/checkout@v4.2.2 # 11bd71901bbe5b1630ceea73d27597364c9af683
      - uses: actions/setup-python@v5.6.0 # a26af69be951a213d495a4c3e4e4022e16d87065
        with:
          python-version: "3.12"
      - name: Check CI health and remediate
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          python scripts/check_ci_status.py \
            --wait-minutes 10 \
            --pending-grace-minutes 15 \
            --stale-minutes 180 \
            --cancel-stale \
            --dispatch-missing \
            --poll-seconds 30 \
            --ref "${{ github.event.workflow_run.head_branch || 'main' }}"
      - name: Verify branch protection on main
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          python scripts/verify_branch_protection.py \
            --branch "${{ github.event.workflow_run.head_branch || 'main' }}" \
            --required-check "âœ… PR CI / Lint (ruff)" \
            --required-check "âœ… PR CI / Smoke tests" \
            --required-check "ğŸš€ CI â€” Insight Demo / ğŸ§¹ Ruff + ğŸ·ï¸ Mypy (3.11)" \
            --required-check "ğŸš€ CI â€” Insight Demo / ğŸ§¹ Ruff + ğŸ·ï¸ Mypy (3.12)" \
            --required-check "ğŸš€ CI â€” Insight Demo / âœ… Actionlint" \
            --required-check "ğŸš€ CI â€” Insight Demo / âœ… Pytest (3.11)" \
            --required-check "ğŸš€ CI â€” Insight Demo / âœ… Pytest (3.12)" \
            --required-check "ğŸš€ CI â€” Insight Demo / Windows Smoke" \
            --required-check "ğŸš€ CI â€” Insight Demo / macOS Smoke" \
            --required-check "ğŸš€ CI â€” Insight Demo / ğŸ“œ MkDocs" \
            --required-check "ğŸš€ CI â€” Insight Demo / ğŸ“š Docs Build" \
            --required-check "ğŸš€ CI â€” Insight Demo / ğŸ³ Docker build"
