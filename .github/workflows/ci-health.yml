name: "ğŸ©º CI Health"

on:
  workflow_dispatch:
  schedule:
    - cron: "0 * * * *"
  workflow_run:
    workflows:
      - "ğŸš€ CI â€” Insight Demo"
      - "âœ… PR CI"
      - "ğŸ”¥ Smoke Test"
    types:
      - completed

permissions:
  contents: read
  actions: write
  # Keep permissions limited to supported keys recognized by GitHub Actions.
  # Allowed keys: actions, checks, contents, deployments, id-token,
  # issues, discussions, packages, pages, pull-requests, repository-projects,
  # security-events, statuses.

concurrency:
  group: ${{ github.workflow }}-${{ github.ref }}
  cancel-in-progress: true

jobs:
  ci-health:
    name: "CI watchdog"
    runs-on: ubuntu-latest
    timeout-minutes: 20
    env:
      CI_TARGET_BRANCH: ${{ (github.event.workflow_run.event == 'pull_request' && github.event.workflow_run.pull_requests[0].base.ref) || 'main' }}
      AGIALPHA_ADDRESS: "0xa61a3b3a130a9c20768eebf97e21515a6046a1fa"
      AGIALPHA_DECIMALS: 18
    steps:
      - uses: actions/checkout@v4.2.2 # 11bd71901bbe5b1630ceea73d27597364c9af683
      - name: Verify $AGIALPHA configuration
        run: python scripts/check_agialpha_config.py
      - uses: actions/setup-python@v5.6.0 # a26af69be951a213d495a4c3e4e4022e16d87065
        with:
          python-version: "3.12"
      - name: Check CI health and remediate
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          CI_TARGET_BRANCH: ${{ (github.event.workflow_run.event == 'pull_request' && github.event.workflow_run.pull_requests[0].base.ref) || 'main' }}
        run: |
          python scripts/check_ci_status.py \
            --wait-minutes 10 \
            --pending-grace-minutes 10 \
            --stale-minutes 60 \
            --cancel-stale \
            --dispatch-missing \
            --poll-seconds 30 \
            --ref "${CI_TARGET_BRANCH}"
      - name: Warn when admin token is unavailable
        if: ${{ secrets.ADMIN_GITHUB_TOKEN == '' }}
        run: echo "::warning::ADMIN_GITHUB_TOKEN not configured; branch protection verification skipped."

      - name: Verify branch protection on main
        if: ${{ secrets.ADMIN_GITHUB_TOKEN != '' }}
        env:
          # Requires a fine-grained or classic PAT with administration access
          # to branch protection settings. The default GITHUB_TOKEN lacks this
          # scope and will return 403s when querying protection rules.
          GITHUB_TOKEN: ${{ secrets.ADMIN_GITHUB_TOKEN }}
          CI_TARGET_BRANCH: ${{ (github.event.workflow_run.event == 'pull_request' && github.event.workflow_run.pull_requests[0].base.ref) || 'main' }}
        run: |
          python scripts/verify_branch_protection.py \
            --branch "${CI_TARGET_BRANCH}" \
            --apply \
            --required-check "âœ… PR CI / Lint (ruff)" \
            --required-check "âœ… PR CI / Smoke tests" \
            --required-check "ğŸš€ CI â€” Insight Demo / ğŸ§¹ Ruff + ğŸ·ï¸ Mypy (3.11)" \
            --required-check "ğŸš€ CI â€” Insight Demo / ğŸ§¹ Ruff + ğŸ·ï¸ Mypy (3.12)" \
            --required-check "ğŸš€ CI â€” Insight Demo / âœ… Actionlint" \
            --required-check "ğŸš€ CI â€” Insight Demo / âœ… Pytest (3.11)" \
            --required-check "ğŸš€ CI â€” Insight Demo / âœ… Pytest (3.12)" \
            --required-check "ğŸš€ CI â€” Insight Demo / Windows Smoke" \
            --required-check "ğŸš€ CI â€” Insight Demo / macOS Smoke" \
            --required-check "ğŸš€ CI â€” Insight Demo / ğŸ“œ MkDocs" \
            --required-check "ğŸš€ CI â€” Insight Demo / ğŸ“š Docs Build" \
            --required-check "ğŸš€ CI â€” Insight Demo / ğŸ³ Docker build" \
            --required-check "ğŸ©º CI Health / CI watchdog"
