name: "ðŸŒ© Load Test"

on:
  schedule:
    - cron: '0 5 * * *'
  pull_request:
  workflow_dispatch:

jobs:
  load-test:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - uses: actions/setup-python@v5
        with:
          python-version: '3.11'
          cache: pip
      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install -r requirements.lock
      - name: Start API server
        run: |
          API_TOKEN=test-token python -m src.interface.api_server &
          pid=$!
          for i in {1..50}; do
            curl -fs http://localhost:8000/healthz && break
            sleep 2
          done
          echo $pid > server.pid
      - name: Install k6
        run: sudo apt-get update && sudo apt-get install -y k6
      - name: Run load test
        run: |
          make loadtest API_TOKEN=test-token
      - name: Stop server
        run: kill $(cat server.pid)
      - name: Upload summary
        uses: actions/upload-artifact@v4
        with:
          name: loadtest-summary
          path: tools/loadtest/summary.json
      - name: Comment results
        if: ${{ github.event.pull_request }}
        uses: actions/github-script@v7
        with:
          script: |
            const fs = require('fs');
            const data = JSON.parse(fs.readFileSync('tools/loadtest/summary.json', 'utf8'));
            const p95 = data.metrics.http_req_duration['p(95)'];
            const rps = data.metrics.http_reqs.rate;
            const body = `Load test results\n- p95 latency: ${p95} ms\n- throughput: ${rps.toFixed(2)} req/s`;
            await github.rest.issues.createComment({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: context.payload.pull_request.number,
              body
            });
