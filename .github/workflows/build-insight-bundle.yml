# Regenerates the α‑AGI Insight docs bundle when relevant files change.
# The workflow rebuilds the Insight browser assets and commits the refreshed
# docs/alpha_agi_insight_v1/insight.bundle.js back to the repository.
name: build-insight-bundle

on:
  workflow_dispatch:
  push:
    branches: [main]
    paths:
      - 'docs/alpha_agi_insight_v1/**'
      - 'alpha_factory_v1/demos/alpha_agi_insight_v1/**'
      - 'package.json'
      - 'package-lock.json'
      - '**/vite.config.*'
      - '**/rollup.config.*'
      - '**/webpack.config.*'

permissions:
  contents: write

jobs:
  build-insight-bundle:
    runs-on: ubuntu-latest
    env:
      WORKDIR: alpha_factory_v1/demos/alpha_agi_insight_v1/insight_browser_v1
    steps:
      - name: Check out repository
        uses: actions/checkout@v4

      - name: Set up Node.js 20
        uses: actions/setup-node@v4
        with:
          node-version: 20

      - name: Select bundle build script
        id: select-script
        run: |
          PACKAGE_JSON="$WORKDIR/package.json"
          if [ ! -f "$PACKAGE_JSON" ]; then
            echo "package.json not found at $PACKAGE_JSON" >&2
            exit 1
          fi
          SCRIPT=$(node -e "const fs=require('fs');const pkg=JSON.parse(fs.readFileSync(process.env.PACKAGE_JSON,'utf8'));const order=['build:docs-insight','build:insight','build'];const found=order.find((name)=>pkg.scripts&&pkg.scripts[name]);if(!found){console.error('No suitable build script found in package.json');process.exit(1);}console.log(found);")
          echo "BUILD_SCRIPT=$SCRIPT" >> "$GITHUB_ENV"

      - name: Install dependencies
        run: npm ci
        working-directory: ${{ env.WORKDIR }}

      - name: Build Insight docs bundle
        run: |
          npm run "$BUILD_SCRIPT"
          DOCS_DIR="$GITHUB_WORKSPACE/docs/alpha_agi_insight_v1"
          OUT_DIR="$GITHUB_WORKSPACE/$WORKDIR/dist"
          mkdir -p "$DOCS_DIR"
          rsync -a --delete "$OUT_DIR/" "$DOCS_DIR/"
        working-directory: ${{ env.WORKDIR }}

      - name: Commit updated Insight bundle
        uses: stefanzweifel/git-auto-commit-action@v5
        with:
          commit_message: "chore: auto-regenerate docs Insight bundle"
          file_pattern: docs/alpha_agi_insight_v1/**
