# Build and commit the Î±-AGI Insight docs bundle when relevant files change.
name: Build Insight Bundle

on:
  workflow_dispatch:
  push:
    branches: [main]
    paths:
      - 'docs/alpha_agi_insight_v1/**'
      - 'alpha_factory_v1/demos/alpha_agi_insight_v1/**'
      - 'package.json'
      - 'package-lock.json'
      - 'vite.config.*'
      - 'rollup.config.*'
      - 'webpack.config.*'

jobs:
  build-insight-bundle:
    runs-on: ubuntu-latest
    defaults:
      run:
        shell: bash
        working-directory: alpha_factory_v1/demos/alpha_agi_insight_v1/insight_browser_v1

    steps:
      - name: Check out repository
        uses: actions/checkout@v4

      - name: Set up Node.js 20
        uses: actions/setup-node@v4
        with:
          node-version: 20

      - name: Install dependencies
        run: npm ci

      - name: Detect build script
        id: build-script
        run: |
          script=$(node - <<'NODE'
          const fs = require('fs');
          const pkgPath = 'package.json';
          if (!fs.existsSync(pkgPath)) {
            console.error('package.json not found');
            process.exit(1);
          }
          const pkg = JSON.parse(fs.readFileSync(pkgPath, 'utf8'));
          const scripts = pkg.scripts || {};
          if (scripts['build:docs-insight']) { console.log('build:docs-insight'); return; }
          if (scripts['build:insight']) { console.log('build:insight'); return; }
          if (scripts['build']) { console.log('build'); return; }
          console.error('No suitable build script found');
          process.exit(1);
          NODE
          )
          echo "value=$script" >> "$GITHUB_OUTPUT"

      - name: Build docs Insight bundle
        run: npm run ${{ steps.build-script.outputs.value }}

      - name: Commit regenerated bundle
        uses: stefanzweifel/git-auto-commit-action@v5
        with:
          commit_message: chore: auto-regenerate docs Insight bundle
          file_pattern: docs/alpha_agi_insight_v1/**
