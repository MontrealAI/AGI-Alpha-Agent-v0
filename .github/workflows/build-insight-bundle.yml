# Regenerates the α‑AGI Insight docs bundle when relevant files change.
# Detects the appropriate build script, rebuilds the Insight assets, and commits
# the refreshed docs/alpha_agi_insight_v1/insight.bundle.js back to the repo.
name: build-insight-bundle

on:
  workflow_dispatch:
  push:
    branches: [main]
    paths:
      - docs/alpha_agi_insight_v1/**
      - alpha_factory_v1/demos/alpha_agi_insight_v1/**
      - package.json
      - package-lock.json
      - vite.config.*
      - rollup.config.*
      - webpack.config.*

permissions:
  contents: write

jobs:
  build-insight-bundle:
    runs-on: ubuntu-latest
    env:
      WORKDIR: alpha_factory_v1/demos/alpha_agi_insight_v1/insight_browser_v1
      DOCS_DIR: docs/alpha_agi_insight_v1
    steps:
      - name: Check out repository
        uses: actions/checkout@v4

      - name: Set up Node.js 20
        uses: actions/setup-node@v4
        with:
          node-version: 20

      - name: Detect Insight docs build script
        id: build-script
        working-directory: ${{ env.WORKDIR }}
        run: |
          SCRIPT=$(node <<'NODE'
            const fs = require('fs');
            const pkg = JSON.parse(fs.readFileSync('package.json', 'utf8'));
            const candidates = ['build:docs-insight', 'build:insight', 'build'];
            const selected = candidates.find((name) => pkg?.scripts?.[name]);
            if (!selected) {
              console.error('No suitable build script found in package.json');
              process.exit(1);
            }
            console.log(selected);
          NODE
          )
          echo "script=${SCRIPT}" >> "$GITHUB_OUTPUT"

      - name: Install dependencies
        working-directory: ${{ env.WORKDIR }}
        run: npm ci

      - name: Build Insight docs bundle
        env:
          BUILD_SCRIPT: ${{ steps.build-script.outputs.script }}
        working-directory: ${{ env.WORKDIR }}
        run: |
          npm run "$BUILD_SCRIPT"
          TARGET_DIR="${GITHUB_WORKSPACE}/${{ env.DOCS_DIR }}"
          mkdir -p "$TARGET_DIR"
          rsync -a --delete dist/ "$TARGET_DIR/"

      - name: Commit updated Insight bundle
        uses: stefanzweifel/git-auto-commit-action@v5
        with:
          commit_message: "chore: auto-regenerate docs Insight bundle"
          file_pattern: docs/alpha_agi_insight_v1/**
