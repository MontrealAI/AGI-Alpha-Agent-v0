# SPDX-License-Identifier: Apache-2.0
name: Setup CI Environment
description: Build sandbox image, install Playwright browsers and show tool versions.
runs:
  using: composite
  steps:
    - name: Resolve sandbox image tag
      id: resolve-sandbox
      shell: bash
      run: |
        # Normalize and validate the sandbox tag so docker always receives a non-empty value.
        resolved="${SANDBOX_IMAGE:-selfheal-sandbox:latest}"
        resolved="${resolved//[[:space:]]/}"

        if [[ -z "$resolved" ]]; then
          echo "::error::SANDBOX_IMAGE is empty. Provide a tag or rely on the default selfheal-sandbox:latest."
          exit 1
        fi

        echo "SANDBOX_IMAGE=$resolved" >> "$GITHUB_ENV"
        echo "resolved=$resolved" >> "$GITHUB_OUTPUT"
        echo "Using sandbox image tag: $resolved"

    - name: Build sandbox image
      shell: bash
      env:
        SANDBOX_IMAGE: ${{ steps.resolve-sandbox.outputs.resolved }}
      run: |
        if [[ -z "${SANDBOX_IMAGE}" ]]; then
          echo "::error::Resolved SANDBOX_IMAGE is empty; aborting sandbox build."
          exit 1
        fi

        docker build -t "${SANDBOX_IMAGE}" -f sandbox.Dockerfile .
    - name: Show tool versions
      shell: bash
      run: |
        python --version
        node --version
        docker --version
        docker compose version
        git --version
    - name: Install Playwright browsers
      shell: bash
      run: python -m playwright install chromium webkit firefox || echo "SKIP_WEBKIT_TESTS=1" >> "$GITHUB_ENV"
