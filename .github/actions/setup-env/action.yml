# SPDX-License-Identifier: Apache-2.0
name: Setup CI Environment
description: Build sandbox image, install Playwright browsers and show tool versions.
runs:
  using: composite
  steps:
    - name: Resolve sandbox image tag
      shell: bash
      run: |
        resolved="${SANDBOX_IMAGE:-selfheal-sandbox:latest}"

        if [[ -z "$resolved" ]]; then
          echo "::error::SANDBOX_IMAGE is empty. Provide a tag or rely on the default selfheal-sandbox:latest."
          exit 1
        fi

        echo "SANDBOX_IMAGE=$resolved" >> "$GITHUB_ENV"
        echo "Using sandbox image tag: $resolved"

    - name: Build sandbox image
      shell: bash
      run: docker build -t "$SANDBOX_IMAGE" -f sandbox.Dockerfile .
    - name: Show tool versions
      shell: bash
      run: |
        python --version
        node --version
        docker --version
        docker compose version
        git --version
    - name: Install Playwright browsers
      shell: bash
      run: python -m playwright install chromium webkit firefox || echo "SKIP_WEBKIT_TESTS=1" >> "$GITHUB_ENV"
